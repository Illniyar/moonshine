var assert = require("assert"),
    request = require("superagent")

process.setMaxListeners(0);
describe("test static files",function(){
    var moonshine = null
    afterEach(function(done){
        Object.keys(require.cache).forEach(function(key){
            delete require.cache[key];
        })
        global.__moonshine_loaded = undefined
        done()
    })
    it("should serve static files",function(done){
        var moonshine = require("moonshine-core")
        moonshine.runCommand("runserver",[require.resolve("moonshine-core-base")
                ,require.resolve("moonshine-core-logging")
                ,require.resolve("moonshine-core-server")
                ,require.resolve("../")
                ,require.resolve("./_test_app")])
            .then(function(){
                request.agent().get('http://localhost:' + moonshine.server.httpServer.address().port + "/test.txt")
                    .end(function(err,res){
                        if (err) return done(err)
                        assert.equal(res.text,"the text that is inside")
                        moonshine.server.shutdown(done)
                    })
            })
            .otherwise(done)
    })
    it("should serve static files from different routes",function(done){
        var moonshine = require("moonshine-core")
        moonshine.runCommand("runserver",[require.resolve("moonshine-core-base")
                ,require.resolve("moonshine-core-logging")
                ,require.resolve("moonshine-core-server")
                ,require.resolve("../")
                ,require.resolve("./_different_url_test_app")])
            .then(function(){
                request.agent().get('http://localhost:' + moonshine.server.httpServer.address().port + "/different/test.txt")
                    .end(function(err,res){
                        if (err) return done(err)
                        assert.equal(res.text,"inside test page")
                        moonshine.server.shutdown(done)
                    })
            })
            .otherwise(done)
    })
    it("should override static files",function(done){
        var moonshine = require("moonshine-core")
        moonshine.runCommand("runserver",[require.resolve("moonshine-core-base")
                ,require.resolve("moonshine-core-logging")
                ,require.resolve("moonshine-core-server")
                ,require.resolve("../")
                ,require.resolve("./_parent_test_app")])
            .then(function(){
                request.agent().get('http://localhost:' + moonshine.server.httpServer.address().port + "/test.txt")
                    .end(function(err,res){
                        if (err) return done(err)
                        assert.equal(res.text,"the text that is inside the parent")
                        moonshine.server.shutdown(done)
                    })
            })
            .otherwise(done)
    })

})
describe("test alias files",function(){
    var moonshine = null
    afterEach(function(done){
        Object.keys(require.cache).forEach(function(key){
            delete require.cache[key];
        })
        global.__moonshine_loaded = undefined
        done()
    })
    it("should serve default alias",function(done){
        var moonshine = require("moonshine-core")
        moonshine.runCommand("runserver",[require.resolve("moonshine-core-base")
                ,require.resolve("moonshine-core-logging")
                ,require.resolve("moonshine-core-server")
                ,require.resolve("../")
                ,require.resolve("./_test_app")])
            .then(function(){
                request.agent().get('http://localhost:' + moonshine.server.httpServer.address().port + "/")
                    .end(function(err,res){
                        if (err) return done(err)
                        assert.equal(res.text,"inside index.html")
                        moonshine.server.shutdown(done)
                    })
            })
            .otherwise(done)
    })
    it("should serve different aliases",function(done){
        var moonshine = require("moonshine-core")
        moonshine.runCommand("runserver",[require.resolve("moonshine-core-base")
                ,require.resolve("moonshine-core-logging")
                ,require.resolve("moonshine-core-server")
                ,require.resolve("../")
                ,require.resolve("./_test_app_alias")])
            .then(function(){
                request.agent().get('http://localhost:' + moonshine.server.httpServer.address().port + "/")
                    .end(function(err,res){
                        if (err) return done(err)
                        assert.equal(res.text,"the text that is inside")
						request.agent().get('http://localhost:' + moonshine.server.httpServer.address().port + "/zzzz")
						.end(function(err,res){
							if (err) return done(err)
							assert.equal(res.text,"the text that is inside")
							moonshine.server.shutdown(done)
						})
                    })
            })
            .otherwise(done)
    })

})
