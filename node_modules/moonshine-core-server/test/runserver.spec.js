var assert = require("assert"),
    request = require("superagent")

describe("test runserver command",function(){
    var moonshine = null
    afterEach(function(done){
        Object.keys(require.cache).forEach(function(key){
            delete require.cache[key];
        })
        global.__moonshine_loaded = undefined
        done()
    })
    it("should start server",function(done){
        var moonshine = require("moonshine-core")
        moonshine.runCommand("runserver",[require.resolve("moonshine-core-base")
                ,require.resolve("moonshine-core-logging")
                ,require.resolve("../")])
            .then(function(){
                assert.ok(moonshine.server)
                moonshine.server.app.get("/test",function(req,res,next){
                    res.send(200,"the test result!")
                })
                request.agent().get('http://localhost:' + moonshine.server.httpServer.address().port + "/test")
                    .end(function(err,res){
                        if (err) return done(err)
                        assert.equal(res.text,"the test result!")
                        moonshine.server.shutdown(done)
                    })
            })
            .otherwise(done)
    })

})

