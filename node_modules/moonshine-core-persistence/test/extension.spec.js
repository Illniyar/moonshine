var assert = require("assert")
describe("persistence extension test",function(){
    var moonshine = null;
    before(function(done){
        moonshine = require("moonshine-core")
        moonshine.load(require.resolve("moonshine-core-base")
            ,require.resolve("moonshine-core-logging")
            ,require.resolve("../")
        ,require.resolve("./_mock_app"))
        .then(function(){
                moonshine.persistence.native.connection.db.dropDatabase(function (err) {
                    done(err);
                });
            },done)
    })
    afterEach(function(done){
        Object.keys(require.cache).forEach(function(key){
            delete require.cache[key];
        })
        global.__moonshine_loaded = undefined
        done()
    })
    it("should register model and enable accessing it",function(done){
        var Model = moonshine.persistence.models["persistests"]
        var model = new Model({text:"the text"})
        model.save(function(err){
            if (err) return done(err)
            Model.find({text:"the text"},function(err,dbModel){
                if (err) return done(err)
                assert.equal(dbModel[0].text,"the text")
                done()
            })
        })
    })
})